id: api-to-bq-gcs-stg
namespace: eq-proj

variables:
  year: "{{trigger.date | date('yyyy')}}"
  month: "{{trigger.date | date('MM')}}"

tasks:
  - id: set_label
    type: io.kestra.plugin.core.execution.Labels
    labels:
      period: "{{render(vars.year)}}-{{render(vars.month)}}"

  - id: run_script
    type: io.kestra.plugin.scripts.python.Commands
    beforeCommands:
      - uv venv  2> /dev/null
      - uv pip install kestra "dlt[bigquery,duckdb,filesystem,gs]" 2> /dev/null
      - uv pip install reverse-geocode google-cloud-bigquery-storage 2> /dev/null
      - . .venv/bin/activate 2> /dev/null
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    namespaceFiles:
      enabled: true
    env:
      DESTINATION__FILESYSTEM__BUCKET_URL: "{{kv('DESTINATION__FILESYSTEM__BUCKET_URL')}}"
    commands:
      - python ingest_data.py {{render(vars.year)}} {{render(vars.month)}}

triggers:
  - id: trigger_run
    type: io.kestra.plugin.core.trigger.Schedule
    cron: 0 0 1 * *
    disabled: false
